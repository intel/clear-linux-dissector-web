{% extends "layerindex/comparisonrecipebase.html" %}
{% load i18n %}

{% comment %}

  layerindex-web - comparison recipe detail page template

  Copyright (C) 2013, 2018 Intel Corporation
  Licensed under the MIT license, see COPYING.MIT for details

{% endcomment %}


<!--
{% autoescape on %}
{% block title_append %} - {{ branch.short_description }} - {{ recipe.pn }}{% endblock %}
{% endautoescape %}
-->

        {% block breadcrumbs %}
        <ul class="breadcrumb">
            <li><a href="{% url 'comparison_recipe_search' branch.name %}">{{ branch.short_description }}</a></li>
            <li class="active">{{ recipe.name }}</li>
        </ul>
        {% endblock %}

            {% block page_heading %}
            <div class="page-header">
                <h1>{{ recipe.name }} {{ recipe.pv }}</h1>
            </div>
                {% if branch.name == 'oe-classic' %}
                <div class="alert alert-warning">
                    <b>NOTE:</b> This recipe is for OE-Classic, the older monolithic version of OpenEmbedded which is no longer actively developed. See below for migration information. If no replacement is available in current OpenEmbedded layers, you may be able to <a href="http://www.openembedded.org/wiki/Migrating_metadata_to_OE-Core">migrate the recipe</a> yourself.
                </div>
                {% endif %}
            {% endblock %}

{% block to_recipe_extra %}{% if recipe.cover_verified %} <span class="label label-info">verified</span>{% endif %}{% if recipe.needs_attention %} <span class="label label-warning">needs attention</span>{% endif %}{% endblock %}

                            {% block selectbuttons %}
                            {% if can_edit %}
                            <a href="{% url 'comparison_select' recipe.id %}?q={{recipe.pn}}" class="btn btn-info">Select...</a>
                            {% endif %}
                            {% endblock %}

                            {% block origin_row %}
                            {% if branch.name == 'oe-classic' %}
                            <th>Origin</th>
                            {% else %}
                            <th>Distro / Layer</th>
                            {% endif %}
                            <td><a href="{% url 'comparison_recipe_search' branch.name %}">{{ branch.short_description }}</a></td>
                            <td>{% if cover_recipe %}<a href="{% url 'layer_item' cover_recipe.layerbranch.branch.name cover_recipe.layerbranch.layer.name %}">{{  cover_recipe.layerbranch.layer }} ({{ cover_recipe.layerbranch.branch.name }} branch)</a>{% endif %}</td>
                            {% endblock %}

                        {% block table_extra %}
                        {% if recipe.extra_urls %}
                        <tr>
                            <th>Extra links</th>
                            <td>
                                <ul class="list-unstyled">
                                {% for extra_url in recipe.extra_urls %}
                                    <li><a href="{{ extra_url.url }}">{{ extra_url.name }}</a></li>
                                {% endfor %}
                                </ul>
                            </td>
                            <td>
                            </td>
                        </tr>
                        {% endif %}
                        {% endblock %}

                {% block patch_table_heading %}
                <h2>Patches</h2>
                {% if can_disposition_patches and recipe.patch_set.exists and recipe.no_export_reason %}
                <div class="alert alert-warning">
                    <b>NOTE:</b> This recipe will not be exported: {{ recipe.no_export_reason }}
                </div>
                {% endif %}
                {% endblock %}
                                    {% block patch_status_heading %}
                                    {% if rcp.layerbranch.branch.comparison %}
                                        {% if can_disposition_patches %}
                                    <th class="col-md-3">Disposition</th>
                                    <th></th>
                                        {% endif %}
                                    {% else %}
                                    <th class="col-md-3">Status</th>
                                    {% endif %}
                                    {% endblock %}

                                    {% block patch_status %}
                                    {% if rcp.layerbranch.branch.comparison %}
                                        {% if can_disposition_patches %}
                                        <td id="patch_{{ patch.id }}_disposition_cell">{{ patch.patchdisposition.get_disposition_display }}</td>
                                        <td><a href="#patchDialog" role="button" data-toggle="modal" class="btn btn-default pull-right patch_disposition_button" id="patch_link_{{ patch.id }}" patch-id="{{ patch.id }}" patch-disposition="{{ patch.patchdisposition.disposition }}" patch-comment="{{ patch.patchdisposition.comment }}" patch-name="{{ patch.src_path }}">...</a></td>
                                        {% endif %}
                                    {% else %}
                                    <td>{{ patch.get_status_display }} {{ patch.status_extra | urlize }}</td>
                                    {% endif %}
                                    {% endblock %}

{% block content_extra %}
{% if can_disposition_patches %}
    <form id="patch_form" method="post">
        <div id="patchDialog" class="modal fade patchdialog" tabindex="-1" role="dialog" aria-labelledby="patchDialogLabel">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h3 id="patchDialogLabel">Dialog title</h3>
                    </div>
                    <div class="modal-body">
                        {% csrf_token %}
                        {{ patch_form }}
                        <div class="alert alert-danger" style="display: none;" id="patchDialogAlert"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary patchdialog-save">Save</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->
    </form>
{% endif %}
{% endblock %}

{% block scripts_extra %}
{% if can_disposition_patches %}
    $('.patch_disposition_button').click(function (e) {
        $('#patchDialogAlert').hide();
        patch_id = $(this).attr('patch-id');
        patch_name = $(this).attr('patch-name');
        patch_disposition = $(this).attr('patch-disposition')
        if( patch_disposition ) {
            $('#id_dispositionform-disposition').val(patch_disposition);
        }
        else {
            $('#id_dispositionform-disposition').val('A');
        }
        $('#id_dispositionform-comment').val($(this).attr('patch-comment'))
        $('#id_dispositionform-patch').val(patch_id)
        $('#patchDialogLabel').html('Disposition patch ' + patch_name);
    });
    $('.patchdialog-save').click(function (e) {
        patch_id = $('#id_dispositionform-patch').val();
        $.post(
            '{% url 'patch_disposition_update' %}',
            $('#patch_form').serialize()
        ).done(function( data, status, xhr ) {
            error = xhr.getResponseHeader('X-Form-Errors');
            if( error ) {
                $('#patchDialogAlert').html('Form error: ' + error);
                $('#patchDialogAlert').show();
            }
            else {
                $('#patchDialog').modal('hide');
                patch_link = $('#patch_link_' + patch_id);
                $('#patch_' + patch_id + '_disposition_cell').html($('#id_dispositionform-disposition option:selected').text());
                patch_link.attr('patch-disposition', $('#id_dispositionform-disposition').val());
                patch_link.attr('patch-comment', $('#id_dispositionform-comment').val());
            }
        }).fail(function( xhr, status, errorThrown ) {
            $('#patchDialogAlert').html('Submit error: ' + errorThrown);
            $('#patchDialogAlert').show();
        });
    });
{% endif %}
{% endblock %}

